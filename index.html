<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Ether Soul</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=EB+Garamond:wght@700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Manrope', sans-serif;
        }
        
        /* Mobile-specific optimizations */
        html, body {
            overscroll-behavior-y: none; /* Prevent pull-to-refresh */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            touch-action: manipulation; /* Faster tap response */
        }
        
        /* Prevent double-tap zoom on mobile */
        * {
            touch-action: manipulation;
        }

        .header-title {
            font-family: 'EB Garamond', serif;
        }

        .ether-word {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: inline-block;
        }

        .soul-word {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: inline-block;
        }

        .ether-word::first-letter,
        .soul-word::first-letter {
            font-size: 1.4em;
        }

        /* Spiritual Logo Styles */
        .ether-logo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            filter: drop-shadow(0 0 15px rgba(251, 146, 60, 0.4));
            transition: all 0.3s ease;
            background: transparent;
            mix-blend-mode: screen;
            object-fit: cover;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            border: 2px solid rgba(251, 146, 60, 0.2);
            padding: 2px;
        }

        .ether-logo:hover {
            filter: drop-shadow(0 0 25px rgba(251, 146, 60, 0.7));
            transform: scale(1.05);
            border-color: rgba(251, 146, 60, 0.4);
        }

        /* Background Logo Watermark */
        #chat-container {
            position: relative;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        #chat-container::before {
            content: '';
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 600px;
            height: 600px;
            background-image: url('logo.png');
            background-repeat: no-repeat;
            background-position: center;
            background-size: cover;
            opacity: 0.25;
            z-index: 0;
            pointer-events: none;
            mix-blend-mode: screen;
            border-radius: 50%;
            filter: blur(1px) brightness(1.2);
        }

        #chat-container>* {
            position: relative;
            z-index: 1;
        }

        /* Heartbeat animation for typing indicator */
        @keyframes heartbeat {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.8;
            }

            50% {
                transform: scale(1.15);
                opacity: 1;
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 0.4;
            }

            50% {
                opacity: 1;
            }
        }

        /* Voice recording animation */
        @keyframes voicePulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(239, 68, 68, 0);
            }
        }

        .voice-recording {
            animation: voicePulse 1.5s infinite;
            background-color: #ef4444 !important;
        }

        .thinking-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 14px 22px;
            background: rgba(139, 92, 246, 0.12);
            border-radius: 24px;
            margin: 10px 0;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .thinking-indicator .heart-icon {
            animation: heartbeat 1.2s ease-in-out infinite;
            font-size: 20px;
            filter: drop-shadow(0 0 8px rgba(139, 92, 246, 0.5));
        }

        .thinking-indicator .thinking-text {
            color: rgba(167, 139, 250, 0.9);
            font-size: 14px;
            font-weight: 500;
        }

        .thinking-indicator .dots {
            display: flex;
            gap: 5px;
            margin-left: 3px;
        }

        .thinking-indicator .dot {
            width: 7px;
            height: 7px;
            background: rgba(139, 92, 246, 0.8);
            border-radius: 50%;
            animation: pulse 1.4s ease-in-out infinite;
        }

        .thinking-indicator .dot:nth-child(1) {
            animation-delay: 0s;
        }

        .thinking-indicator .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .thinking-indicator .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        /* Auth Modal Styles */
        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .auth-modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .auth-modal-content {
            background: linear-gradient(135deg, #0f172a 0%, #020617 100%);
            border: 1px solid rgba(255, 215, 0, 0.15);
            border-radius: 16px;
            padding: 35px 40px 30px 40px;
            max-width: 380px;
            width: 90%;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.8);
            animation: slideUp 0.3s ease;
            position: relative;
            overflow: visible;
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .auth-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: transparent;
            border: none;
            color: #9ca3af;
            font-size: 28px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .auth-close:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
        }

        .auth-input {
            width: 100%;
            padding: 14px 18px 14px 45px;
            background: rgba(15, 28, 46, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #ffffff;
            font-size: 15px;
            transition: all 0.3s;
            margin-bottom: 18px;
        }

        .auth-input:focus {
            outline: none;
            border-color: rgba(255, 165, 0, 0.5);
            background: rgba(15, 28, 46, 0.9);
            box-shadow: 0 0 0 3px rgba(255, 165, 0, 0.1);
        }

        .auth-input-wrapper {
            position: relative;
            margin-bottom: 18px;
        }

        .auth-input-wrapper input {
            margin-bottom: 0;
        }

        .auth-input-icon {
            position: absolute;
            left: 13px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            width: 16px;
            height: 16px;
        }

        .auth-input-icon-right {
            position: absolute;
            right: 13px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            width: 16px;
            height: 16px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .auth-input-icon-right:hover {
            color: #9ca3af;
        }

        .auth-input::placeholder {
            color: #6b7280;
        }

        .auth-submit {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #ff9500 0%, #ff7b00 100%);
            color: #ffffff;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 6px;
            box-shadow: 0 4px 15px rgba(255, 149, 0, 0.3);
        }

        .auth-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 149, 0, 0.4);
            background: linear-gradient(135deg, #ffaa00 0%, #ff8800 100%);
        }

        .auth-submit:active {
            transform: translateY(0);
        }

        .auth-divider {
            display: flex;
            align-items: center;
            margin: 16px 0;
            color: #6b7280;
            font-size: 13px;
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
        }

        .auth-divider span {
            padding: 0 16px;
        }

        .auth-switch {
            text-align: center;
            margin-top: 16px;
            color: #9ca3af;
            font-size: 13px;
        }

        .auth-switch button {
            background: none;
            border: none;
            color: #ff9500;
            cursor: pointer;
            font-weight: 600;
            transition: color 0.2s;
        }

        .auth-switch button:hover {
            color: #ffaa00;
        }

        .auth-forgot {
            color: #ff9500;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            transition: color 0.2s;
        }

        .auth-forgot:hover {
            color: #ffaa00;
        }

        .auth-remember {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .auth-remember label {
            display: flex;
            align-items: center;
            color: #9ca3af;
            font-size: 13px;
            cursor: pointer;
        }

        .auth-remember input[type="checkbox"] {
            margin-right: 6px;
            cursor: pointer;
        }

        .auth-modal-content>* {
            position: relative;
            z-index: 1;
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 25px;
        }

        .social-btn {
            width: 100%;
            padding: 13px 16px;
            background: rgba(0, 0, 0, 0.3);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 14px;
        }

        .social-btn:hover {
            background: rgba(0, 0, 0, 0.5);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        /* User Profile & Dropdown */
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 6px 16px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .user-profile:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 215, 0, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255, 215, 0, 0.3);
            background: linear-gradient(135deg, #FFD700, #FFA500);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #1a1a1a;
            font-size: 14px;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }

        .user-name {
            font-size: 14px;
            font-weight: 600;
            color: #f3f4f6;
            max-width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-badge {
            font-size: 11px;
            color: #9ca3af;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .user-badge svg {
            width: 12px;
            height: 12px;
        }

        .user-dropdown {
            position: absolute;
            top: calc(100% + 12px);
            right: 0;
            width: 240px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 8px;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }

        .dropdown-header {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 4px;
        }

        .dropdown-user-email {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 2px;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 10px 16px;
            border-radius: 8px;
            color: #e5e7eb;
            font-size: 14px;
            transition: all 0.2s;
            cursor: pointer;
            text-align: left;
            background: transparent;
            border: none;
        }

        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #FFD700;
        }

        .dropdown-item.logout {
            color: #ef4444;
        }

        .dropdown-item.logout:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        /* Bridge to prevent closing on gap hover */
        .user-profile::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            height: 12px;
            background: transparent;
        }

        /* ========================================
           RESPONSIVE DESIGN - Mobile First
           ======================================== */

        /* Tablet and below (max-width: 768px) */
        @media (max-width: 768px) {

            /* Header adjustments - Better mobile spacing */
            .p-4.flex.justify-between.items-center {
                flex-wrap: nowrap;
                padding: 14px 16px;
                gap: 8px;
                align-items: center;
                display: flex;
            }

            /* Logo section - optimized size and circular */
            .p-4.flex.justify-between.items-center>.w-1\/3:first-child {
                width: auto;
                flex: 0 0 auto;
                display: flex;
                align-items: center;
            }

            .p-4.flex.justify-between.items-center>.w-1\/3:first-child img {
                height: 40px !important;
                width: 40px !important;
                border-radius: 50% !important;
                object-fit: cover !important;
            }

            /* Title section - compact and centered */
            .p-4.flex.justify-between.items-center>.w-1\/3.text-center {
                width: auto;
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .header-title {
                font-size: 1.35rem;
                line-height: 1.2;
            }

            /* Auth buttons section - Touch-friendly */
            .p-4.flex.justify-between.items-center>.w-1\/3.flex.justify-end {
                width: auto;
                flex: 0 0 auto;
                gap: 8px;
                display: flex;
                align-items: center;
            }

            #loginBtn {
                padding: 10px 16px;
                font-size: 13px;
                min-height: 40px;
            }
            
            #signupBtn {
                padding: 10px 18px;
                font-size: 13px;
                min-height: 40px;
                white-space: nowrap;
            }

            /* User profile - compact on mobile */
            .user-profile {
                padding: 6px 12px;
                min-height: 44px;
                display: flex;
                align-items: center;
            }

            .user-info {
                display: none;
            }

            .user-avatar {
                width: 36px;
                height: 36px;
            }

            /* Auth Modal - full width on mobile */
            .auth-modal-content {
                width: 92%;
                max-width: none;
                padding: 28px 22px;
                margin: 18px;
                border-radius: 16px;
                max-height: 90vh;
                overflow-y: auto;
            }

            .auth-modal-content h2 {
                font-size: 1.85rem;
                margin-bottom: 8px;
            }

            .auth-input {
                padding: 14px 16px 14px 44px;
                font-size: 16px;
                min-height: 52px;
                border-radius: 12px;
            }

            .social-btn {
                padding: 14px 16px;
                font-size: 15px;
                min-height: 52px;
                border-radius: 14px;
                gap: 14px;
            }
            
            .auth-submit {
                min-height: 52px;
                font-size: 16px;
                border-radius: 12px;
                padding: 14px;
            }

            /* Chat container - Better mobile spacing */
            #chat-container {
                padding: 16px 14px;
                padding-bottom: 8px;
            }

            /* Background watermark smaller on mobile */
            #chat-container::before {
                width: 300px;
                height: 300px;
                opacity: 0.08;
            }

            /* Chat bubbles - Better mobile width */
            #chat-container .max-w-sm {
                max-width: 82%;
            }
            
            /* Chat messages - Better readability on mobile */
            #chat-container .text-gray-200 {
                font-size: 15px;
                line-height: 1.55;
            }
            
            /* User messages */
            #chat-container .bg-gradient-to-r {
                font-size: 15px;
                line-height: 1.55;
                padding: 12px 16px;
            }
            
            /* Bot messages */
            #chat-container .bg-gray-800 {
                padding: 12px 16px;
            }

            /* Suggestions container - styles now handled by JavaScript inline styles */

            /* Chat input form - Enhanced mobile experience */
            .p-4.bg-gray-950.border-t {
                padding: 14px;
                position: sticky;
                bottom: 0;
                background: linear-gradient(180deg, rgba(3, 7, 18, 0.98) 0%, rgba(15, 23, 42, 1) 100%);
                backdrop-filter: blur(12px);
            }
            
            #chat-form {
                width: 100%;
            }
            
            #chat-form > div {
                display: flex;
                align-items: end;
                padding: 12px 16px;
                border-radius: 24px;
                min-height: 52px;
            }

            #user-input {
                padding: 12px 0;
                padding-right: 100px !important;
                font-size: 16px;
                line-height: 1.4;
                flex: 1;
                min-width: 0;
                max-height: 150px !important;
            }

            /* Buttons - Touch-friendly, absolute positioned */
            #voice-btn, 
            form button[type="submit"] {
                width: 44px !important;
                height: 44px !important;
                flex-shrink: 0;
                min-width: 44px;
                position: static;
            }

            /* Button container positioning */
            #chat-form > div > div {
                position: absolute;
                right: 16px;
                bottom: 8px;
                gap: 8px;
            }

            /* Thinking indicator */
            .thinking-indicator {
                padding: 12px 18px;
                gap: 10px;
                margin: 12px 0;
            }

            .thinking-indicator .thinking-text {
                font-size: 14px;
            }
            
            .thinking-indicator .heart-icon {
                font-size: 22px;
            }

            /* User dropdown positioning */
            .user-dropdown {
                right: 0;
                width: 240px;
                margin-top: 8px;
            }
            
            /* Make dropdown items touch-friendly */
            .dropdown-item {
                min-height: 48px;
                padding: 12px 16px;
                font-size: 15px;
            }
        }

        /* Small mobile (max-width: 480px) */
        @media (max-width: 480px) {

            /* Header optimized for small screens */
            .p-4.flex.justify-between.items-center {
                padding: 12px 14px;
                display: flex;
                align-items: center;
            }

            .p-4.flex.justify-between.items-center>.w-1\/3:first-child {
                display: flex;
                align-items: center;
            }

            .p-4.flex.justify-between.items-center>.w-1\/3:first-child img {
                height: 36px !important;
                width: 36px !important;
                border-radius: 50% !important;
                object-fit: cover !important;
            }

            .p-4.flex.justify-between.items-center>.w-1\/3.text-center {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .header-title {
                font-size: 1.20rem;
            }

            #loginBtn {
                display: none;
                /* Hide sign in on small screens */
            }

            #signupBtn {
                padding: 9px 16px;
                font-size: 13px;
                min-height: 40px;
            }

            /* Modal adjustments */
            .auth-modal-content {
                padding: 24px 18px;
                margin: 14px;
            }

            .auth-modal-content h2 {
                font-size: 1.6rem;
            }

            /* Chat container */
            #chat-container {
                padding: 14px 12px;
            }

            #chat-container::before {
                width: 240px;
                height: 240px;
            }

            #chat-container .max-w-sm {
                max-width: 88%;
            }
            
            /* Better text size for readability */
            #chat-container .text-gray-200,
            #chat-container .bg-gradient-to-r,
            #chat-container .bg-gray-800 {
                font-size: 14.5px;
            }

            /* Chat input - Ensure no zoom on iOS */
            #user-input {
                padding: 14px 52px 14px 16px;
                font-size: 16px;
                min-height: 50px;
                max-height: 160px;
            }
            
            #user-input.expanded {
                border-radius: 18px !important;
            }

            form button[type="submit"] {
                width: 42px;
                height: 42px;
            }
            
            #voice-btn {
                right: 52px !important;
                width: 42px !important;
                height: 42px !important;
            }

            /* Suggestions - styles now handled by JavaScript inline styles */
        }

        /* Enhanced touch-friendly tap targets for mobile devices */
        @media (hover: none) and (pointer: coarse) {

            button,
            .social-btn,
            .dropdown-item {
                min-height: 44px;
                min-width: 44px;
                cursor: pointer;
            }
            
            /* Larger touch targets for interactive elements */
            #loginBtn,
            #signupBtn,
            .auth-submit {
                min-height: 48px;
                padding: 12px 20px;
            }
            
            /* Input fields - prevent iOS zoom */
            input,
            textarea {
                font-size: 16px !important;
            }

            /* Suggestion buttons handled by JavaScript */
        }

        /* Safe area insets for notched phones - iPhone X and newer */
        @supports (padding: max(0px)) {
            body {
                padding-top: env(safe-area-inset-top);
            }
            
            .chat-input-container {
                padding-bottom: max(14px, env(safe-area-inset-bottom));
            }
            
            @media (max-width: 768px) {
                .chat-input-container {
                    padding-bottom: calc(16px + env(safe-area-inset-bottom));
                }
            }
        }

        /* ========================================
           ENHANCED MOBILE BOTTOM BAR STYLES
           ======================================== */

        /* Base Suggestion Button Styles (Desktop) */
        .suggestion-btn {
            color: #d1d5db !important;
            font-size: 14px !important;
            background: transparent !important;
            border: none !important;
            padding: 6px 12px !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            white-space: nowrap !important;
            box-shadow: none !important;
            text-decoration: none !important;
            margin: 0 !important;
            line-height: 1.5 !important;
        }

        .suggestion-btn:hover {
            color: #fbbf24 !important;
            text-decoration: underline !important;
        }

        /* Suggestions Container Base Styles */
        #suggestions-container {
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 8px !important;
            justify-content: flex-end !important;
            background: #030712 !important;
            padding: 8px 16px 4px 16px !important;
        }

        /* Professional Bottom Bar Container */
        .bottom-input-container {
            background: linear-gradient(180deg, rgba(3, 7, 18, 0.95) 0%, rgba(15, 23, 42, 1) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 215, 0, 0.1);
            box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.3);
        }


        /* Enhanced Input Field - Better Visibility */
        #user-input {
            font-size: 16px !important;
            /* Prevents iOS zoom on focus */
            color: #f8fafc !important;
            letter-spacing: 0.01em;
            resize: none;
            overflow-y: hidden;
            min-height: 56px;
            max-height: 200px;
            line-height: 1.5;
            transition: height 0.15s ease, border-radius 0.2s ease;
            font-family: 'Manrope', sans-serif;
        }
        
        #user-input.expanded {
            border-radius: 20px !important;
        }
        
        /* Button styling for outside textarea */
        #voice-btn, 
        form button[type="submit"] {
            flex-shrink: 0;
            min-width: 48px;
        }
        
        /* Ensure form layout stays horizontal */
        #chat-form > div {
            display: flex;
            flex-wrap: nowrap;
            align-items: flex-end;
        }
        
        #user-input {
            flex: 1;
            min-width: 0;
        }

        #user-input::placeholder {
            color: #94a3b8 !important;
            opacity: 1;
        }

        @media (max-width: 768px) {

            /* Bottom Bar Container - Enhanced mobile UI */
            .p-4.bg-gray-950.border-t {
                padding: 14px 14px 18px 14px;
                background: linear-gradient(180deg, rgba(3, 7, 18, 0.98) 0%, rgba(15, 23, 42, 1) 100%);
                border-top: 1px solid rgba(255, 215, 0, 0.18);
                box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.5);
            }
            
            #chat-form {
                width: 100%;
            }
            
            #chat-form > div {
                gap: 10px;
                display: flex;
                flex-wrap: nowrap;
                align-items: flex-end;
            }

            /* Input Field - Maximum visibility and usability */
            #user-input {
                font-size: 16px !important;
                padding: 16px 18px !important;
                background: rgba(30, 41, 59, 0.85) !important;
                border: 1.5px solid rgba(255, 215, 0, 0.22) !important;
                color: #f8fafc !important;
                border-radius: 26px !important;
                box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.25),
                    0 0 0 0 rgba(255, 215, 0, 0);
                transition: all 0.3s ease;
                min-height: 52px !important;
                max-height: 180px !important;
                flex: 1;
                min-width: 0;
            }
            
            #user-input.expanded {
                border-radius: 20px !important;
            }

            #user-input:focus {
                background: rgba(30, 41, 59, 1) !important;
                border-color: rgba(255, 215, 0, 0.4) !important;
                box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2),
                    0 0 0 3px rgba(255, 215, 0, 0.1) !important;
            }

            #user-input::placeholder {
                color: #9ca3af !important;
                font-weight: 400;
            }

            /* Submit Button - Prominent and touch-friendly */
            #voice-btn,
            form button[type="submit"] {
                width: 50px !important;
                height: 50px !important;
                flex-shrink: 0;
                min-width: 50px !important;
            }
            
            form button[type="submit"] {
                background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%) !important;
                border: none !important;
                box-shadow: 0 4px 14px rgba(255, 165, 0, 0.35);
                transition: all 0.2s ease;
            }

            form button[type="submit"]:hover,
            form button[type="submit"]:active {
                transform: scale(1.05);
                box-shadow: 0 6px 18px rgba(255, 165, 0, 0.45);
            }

            form button[type="submit"] svg {
                color: #1a1a1a !important;
                stroke: #1a1a1a !important;
                width: 22px;
                height: 22px;
            }
            
            #voice-btn svg {
                width: 22px;
                height: 22px;
            }

            /* Suggestions - Clean vertical layout */
            #suggestions-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 14px 16px 18px 16px;
                gap: 10px;
                background: transparent;
            }

            .suggestion-btn {
                font-size: 14.5px !important;
                padding: 6px 12px !important;
                background: transparent !important;
                border: none !important;
                color: #e5e7eb !important;
                border-radius: 0 !important;
                font-weight: 400;
                white-space: nowrap;
                transition: all 0.2s ease;
                box-shadow: none !important;
                min-height: 44px !important;
                text-decoration: none !important;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .suggestion-btn:hover,
            .suggestion-btn:active {
                color: #fbbf24 !important;
                background: transparent !important;
                border: none !important;
                text-decoration: underline !important;
                transform: scale(1.02);
            }
        }

        @media (max-width: 480px) {

            /* Optimized for small phones */
            .p-4.bg-gray-950.border-t {
                padding: 12px 10px 16px 10px;
            }
            
            #chat-form > div {
                gap: 8px;
                flex-wrap: nowrap;
            }

            #user-input {
                font-size: 16px !important;
                padding: 14px 16px !important;
                min-height: 50px !important;
                max-height: 160px !important;
                flex: 1;
                min-width: 0;
            }

            #voice-btn,
            form button[type="submit"] {
                width: 46px !important;
                height: 46px !important;
                min-width: 46px !important;
            }
            
            #voice-btn svg,
            form button[type="submit"] svg {
                width: 20px;
                height: 20px;
            }

            /* Suggestions - Compact but still touch-friendly */
            #suggestions-container {
                padding: 12px 14px 16px 14px;
                gap: 8px;
            }

            .suggestion-btn {
                font-size: 14px !important;
                min-height: 44px !important;
            }
        }

        /* Safe area for notched phones (iPhone X+, etc.) */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            @media (max-width: 768px) {
                .p-4.bg-gray-950.border-t {
                    padding-bottom: calc(16px + env(safe-area-inset-bottom));
                }
            }
        }

        /* Touch-friendly adjustments for all mobile devices */
        @media (hover: none) and (pointer: coarse) {
            #user-input {
                font-size: 16px !important;
                /* Prevent iOS zoom on focus */
                -webkit-text-size-adjust: 100%;
            }

            .send-button {
                min-width: 32px;
                min-height: 32px;
            }
            
            .voice-button {
                min-width: 40px;
                min-height: 40px;
            }

            .suggestion-btn {
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
                -webkit-tap-highlight-color: rgba(255, 215, 0, 0.1);
            }
            
            /* Prevent text selection on tap */
            button {
                -webkit-tap-highlight-color: rgba(255, 215, 0, 0.2);
                user-select: none;
                -webkit-user-select: none;
            }
            
            /* Active state feedback for all buttons */
            button:active,
            .social-btn:active,
            .auth-submit:active {
                transform: scale(0.97);
                opacity: 0.9;
            }
            
            /* Input focus - Better visual feedback on mobile */
            #user-input:focus {
                background: rgba(31, 41, 55, 1) !important;
                border-color: rgba(107, 114, 128, 0.8) !important;
                box-shadow: 0 0 0 3px rgba(75, 85, 99, 0.15) !important;
            }
        }
    </style>
</head>

<body class="bg-gray-950 m-0 p-0">
    <!-- Authentication Modal -->
    <div id="authModal" class="auth-modal">
        <div class="auth-modal-content">
            <button class="auth-close" onclick="closeAuthModal()">&times;</button>

            <!-- Login Form -->
            <div id="loginForm">
                <div class="text-center mb-6">
                    <h2 class="text-3xl header-title mb-2">
                        <span class="ether-word">ETHER</span> <span class="soul-word">SOUL</span>
                    </h2>
                    <p class="text-gray-400 text-sm">Sign in to continue</p>
                </div>

                <!-- Google Sign-In Button -->
                <button type="button" onclick="handleSocialLogin('Google')" class="social-btn"
                    style="margin-bottom: 16px; background: white; color: #1f2937; border: 1px solid #e5e7eb;">
                    <svg width="20" height="20" viewBox="0 0 24 24">
                        <path fill="#4285F4"
                            d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                        <path fill="#34A853"
                            d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                        <path fill="#FBBC05"
                            d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                        <path fill="#EA4335"
                            d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                    </svg>
                    Continue with Google
                </button>

                <!-- Guest Access Option -->
                <div class="auth-divider" style="margin: 20px 0 15px 0;"><span>or</span></div>
                <button type="button" onclick="continueAsGuest()" class="social-btn"
                    style="margin-bottom: 0; background: rgba(100, 100, 100, 0.15); border: 1px solid rgba(139, 92, 246, 0.3);">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    Continue as Guest
                </button>
            </div>

            <!-- Signup Form -->
            <div id="signupForm" style="display: none;">
                <div class="text-center mb-6">
                    <h2 class="text-3xl header-title mb-2">
                        <span class="ether-word">ETHER</span> <span class="soul-word">SOUL</span>
                    </h2>
                    <p class="text-gray-400 text-sm">Create your account</p>
                </div>

                <!-- Google Sign-In Button -->
                <button type="button" onclick="handleSocialLogin('Google')" class="social-btn"
                    style="margin-bottom: 16px; background: white; color: #1f2937; border: 1px solid #e5e7eb;">
                    <svg width="20" height="20" viewBox="0 0 24 24">
                        <path fill="#4285F4"
                            d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                        <path fill="#34A853"
                            d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                        <path fill="#FBBC05"
                            d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                        <path fill="#EA4335"
                            d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                    </svg>
                    Continue with Google
                </button>

                <!-- Guest Access Option -->
                <div class="auth-divider" style="margin: 20px 0 15px 0;"><span>or</span></div>
                <button type="button" onclick="continueAsGuest()" class="social-btn"
                    style="margin-bottom: 0; background: rgba(100, 100, 100, 0.15); border: 1px solid rgba(139, 92, 246, 0.3);">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    Continue as Guest
                </button>
            </div>
        </div>
    </div>

    <div class="w-full bg-gray-950 flex flex-col h-screen">
        <div class="p-4 flex justify-between items-center border-b border-gray-800 relative z-50">
            <div class="w-1/3 flex items-center gap-2">
                <!-- Ether Soul Logo -->
                <img src="logo.png" alt="Ether Soul" class="ether-logo">
            </div>
            <div class="w-1/3 text-center">
                <h1 class="text-2xl header-title whitespace-nowrap">
                    <span class="ether-word">ETHER</span>.<span class="soul-word">SOUL</span>
                </h1>
            </div>
            <div class="w-1/3 flex justify-end items-center gap-3">
                <!-- Guest Indicator (Legacy - keeping hidden for compatibility) -->
                <div id="guestIndicator" style="display: none;"></div>

                <!-- User Profile Display (Initially Hidden) -->
                <div id="userProfileDisplay" class="user-profile" style="display: none;">
                    <!-- Avatar/Initials -->
                    <div class="user-avatar">
                        <img id="userAvatarImg" src="" alt="Profile"
                            style="display: none; width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                        <span id="userInitials">US</span>
                    </div>

                    <!-- User Info -->
                    <div class="user-info">
                        <span class="user-name" id="userName">User Name</span>
                        <div class="user-badge">
                            <svg fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                    clip-rule="evenodd"></path>
                            </svg>
                            <span id="userBadgeText">Free Plan</span>
                        </div>
                    </div>

                    <!-- Dropdown Menu -->
                    <div class="user-dropdown">
                        <div class="dropdown-header">
                            <div class="text-sm font-medium text-white">Signed in as</div>
                            <div class="dropdown-user-email" id="userEmail">user@example.com</div>
                        </div>
                        <button class="dropdown-item">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            Profile Settings
                        </button>
                        <button class="dropdown-item logout" onclick="handleLogout()">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                                </path>
                            </svg>
                            Log Out
                        </button>
                    </div>
                </div>

                <button id="loginBtn"
                    class="px-5 py-2 text-sm font-medium text-gray-300 hover:text-white transition-colors duration-200 border border-gray-700 rounded-full hover:border-gray-600">
                    Sign In
                </button>
                <button id="signupBtn"
                    class="px-5 py-2 text-sm font-medium bg-gradient-to-r from-yellow-500 to-orange-500 text-gray-950 rounded-full hover:from-yellow-400 hover:to-orange-400 transition-all duration-200 shadow-lg">
                    Get Started
                </button>
            </div>
        </div>
        <div id="chat-container" class="flex-1 p-4 overflow-y-auto bg-gray-950" style="overscroll-behavior: contain;"></div>
        <div id="suggestions-container"
            style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 12px 16px 16px 16px; gap: 8px; background: transparent;">
        </div>

        <!-- Voice Selector -->
        <div class="p-4 bg-gray-950 border-t border-gray-800">
            <form id="chat-form" class="flex items-center justify-center">
                <div class="w-full max-w-2xl relative flex items-end bg-gray-950 border border-gray-800 rounded-3xl px-4 py-2" style="min-height: 56px;">
                    <textarea id="user-input" placeholder="What can I help with?" rows="1"
                        autocomplete="off" autocorrect="off" autocapitalize="sentences"
                        class="flex-1 py-2 pr-24 bg-transparent border-0 text-gray-200 focus:outline-none placeholder:text-gray-500 text-base resize-none" style="max-height: 200px;"></textarea>
                    <div class="flex items-center gap-2 absolute right-4 bottom-2">
                        <button type="button" id="voice-btn"
                            class="flex-shrink-0 bg-gray-800 text-gray-300 w-10 h-10 rounded-full flex items-center justify-center hover:bg-gray-700 hover:text-white transition-all duration-200">
                            <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                <line x1="12" y1="19" x2="12" y2="23"></line>
                                <line x1="8" y1="23" x2="16" y2="23"></line>
                            </svg>
                            <svg id="stop-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <rect x="6" y="6" width="12" height="12" rx="2"></rect>
                            </svg>
                        </button>
                        <button type="submit"
                            class="flex-shrink-0 bg-gradient-to-r from-yellow-500 to-orange-500 text-gray-950 w-10 h-10 rounded-full flex items-center justify-center hover:from-yellow-400 hover:to-orange-400 transition-all duration-200 shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, query, where, orderBy, limit, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB2MZ1pn4MQSeqA2gRTB0IwA3OcUW372IA",
            authDomain: "voicesofethers.firebaseapp.com",
            projectId: "voicesofethers",
            storageBucket: "voicesofethers.appspot.com",
            messagingSenderId: "155510282478",
            appId: "1:155510282478:web:25706605581ee80294bbff"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // Listen for auth state changes
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log('Firebase auth state: User is signed in', user.email);
                // User is signed in, update localStorage
                localStorage.setItem('etherSoulUser', JSON.stringify({
                    uid: user.uid,
                    email: user.email,
                    name: user.displayName || user.email.split('@')[0],
                    photoURL: user.photoURL,
                    loggedIn: true,
                    loginTime: new Date().toISOString()
                }));
            } else {
                console.log('Firebase auth state: No user signed in');
            }
        });

        // Make available globally for onclick handlers
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.googleProvider = googleProvider;
        window.signInWithPopup = signInWithPopup;
        window.firestoreUtils = { collection, addDoc, updateDoc, deleteDoc, doc, query, where, orderBy, limit, getDocs };
    </script>

    <script>
        // Authentication Functions
        const authModal = document.getElementById('authModal');
        const loginBtn = document.getElementById('loginBtn');
        const signupBtn = document.getElementById('signupBtn');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');

        // Open modal with login form
        loginBtn.addEventListener('click', () => {
            authModal.classList.add('active');
            switchToLogin();
        });

        // Open modal with signup form
        signupBtn.addEventListener('click', () => {
            authModal.classList.add('active');
            switchToSignup();
        });

        // Close modal
        function closeAuthModal() {
            authModal.classList.remove('active');
        }

        // Close on background click
        authModal.addEventListener('click', (e) => {
            if (e.target === authModal) {
                closeAuthModal();
            }
        });

        // Switch between forms
        function switchToLogin() {
            loginForm.style.display = 'block';
            signupForm.style.display = 'none';
        }

        function switchToSignup() {
            loginForm.style.display = 'none';
            signupForm.style.display = 'block';
        }

        // Toggle password visibility
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
            } else {
                input.type = 'password';
            }
        }

        // Handle login submission (disabled - no auth)
        async function handleLogin(event) {
            event.preventDefault();
            alert('Authentication has been disabled. Continue as guest to use the chatbot.');
        }

        // Handle signup submission (disabled - no auth)
        async function handleSignup(event) {
            event.preventDefault();
            alert('Authentication has been disabled. Continue as guest to use the chatbot.');
        }

        // Handle social login with Google using Firebase
        async function handleSocialLogin(provider) {
            if (provider === 'Google') {
                try {
                    console.log('Initiating Google Sign-In with Firebase...');
                    
                    // Show loading state
                    const buttons = document.querySelectorAll('.social-btn');
                    buttons.forEach(btn => {
                        btn.disabled = true;
                        btn.style.opacity = '0.6';
                    });

                    const result = await window.signInWithPopup(window.firebaseAuth, window.googleProvider);
                    const user = result.user;
                    
                    console.log('Google login successful:', user.email);

                    // Extract first name for personalization
                    const fullName = user.displayName || '';
                    currentUserName = fullName.split(' ')[0] || user.email.split('@')[0];

                    // Show success message
                    showAuthSuccess(`Welcome ${user.displayName || 'back'}! Your spiritual journey continues...`);

                    // Store user session
                    localStorage.setItem('etherSoulUser', JSON.stringify({
                        uid: user.uid,
                        email: user.email,
                        name: user.displayName || user.email.split('@')[0],
                        photoURL: user.photoURL,
                        loggedIn: true,
                        loginTime: new Date().toISOString()
                    }));

                    // Update UI
                    updateUIForLoggedInUser({
                        email: user.email,
                        displayName: user.displayName,
                        photoURL: user.photoURL,
                        uid: user.uid
                    });
                    
                    // Clear chat and show personalized welcome
                    chatContainer.innerHTML = '';
                    showPersonalizedWelcome();
                    
                    closeAuthModal();

                } catch (error) {
                    console.error('Google login error:', error);
                    let errorMessage = 'Google login failed. Please try again.';
                    
                    if (error.code === 'auth/popup-closed-by-user') {
                        errorMessage = 'Sign-in cancelled.';
                    } else if (error.code === 'auth/popup-blocked') {
                        errorMessage = 'Pop-up blocked. Please allow pop-ups for this site.';
                    }
                    
                    alert(errorMessage);
                } finally {
                    // Reset button state
                    const buttons = document.querySelectorAll('.social-btn');
                    buttons.forEach(btn => {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    });
                }
            }
        }

        // Update UI for logged-in user
        function updateUIForLoggedInUser(user) {
            const userName = user.user_metadata?.full_name || user.displayName || user.name || user.email?.split('@')[0] || 'User';
            const userEmail = user.email || 'guest@ethersoul.local';
            const isGuest = user.isGuest || user.is_guest || false;

            // Hide login/signup buttons
            loginBtn.style.display = 'none';
            signupBtn.style.display = 'none';

            // Show user profile display
            const userProfileDisplay = document.getElementById('userProfileDisplay');
            const userNameElement = document.getElementById('userName');
            const userEmailElement = document.getElementById('userEmail');
            const userInitials = document.getElementById('userInitials');
            const userBadgeText = document.getElementById('userBadgeText');
            const userAvatarImg = document.getElementById('userAvatarImg');

            if (userProfileDisplay) {
                userProfileDisplay.style.display = 'flex';
            }

            if (userNameElement) {
                userNameElement.textContent = userName;
            }

            if (userEmailElement) {
                userEmailElement.textContent = userEmail;
            }

            // Set initials
            if (userInitials) {
                const initials = userName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                userInitials.textContent = initials;
            }

            // Set badge
            if (userBadgeText) {
                userBadgeText.textContent = isGuest ? 'Guest' : 'Free Plan';
            }

            // If user has profile picture from Google
            const avatarUrl = user.user_metadata?.avatar_url || user.user_metadata?.picture || user.photoURL;
            if (avatarUrl && userAvatarImg) {
                userAvatarImg.src = avatarUrl;
                userAvatarImg.style.display = 'block';
                if (userInitials) userInitials.style.display = 'none';
            } else {
                if (userAvatarImg) userAvatarImg.style.display = 'none';
                if (userInitials) userInitials.style.display = 'flex';
            }

            // Setup dropdown click functionality
            setupProfileDropdown();

            // Ensure voice recognition is initialized after auth
            setTimeout(() => {
                if (typeof initializeVoiceRecognition === 'function') {
                    initializeVoiceRecognition();
                }
            }, 500);
        }

        // Handle logout
        async function handleLogout() {
            try {
                // Sign out from Firebase
                if (window.firebaseAuth) {
                    await window.firebaseAuth.signOut();
                }
                localStorage.removeItem('etherSoulUser');
                location.reload();
            } catch (error) {
                console.error('Logout error:', error);
                localStorage.removeItem('etherSoulUser');
                location.reload();
            }
        }

        // Toggle user profile dropdown on click
        let isDropdownSetup = false;

        function setupProfileDropdown() {
            const userProfile = document.getElementById('userProfileDisplay');
            const userDropdown = userProfile?.querySelector('.user-dropdown');

            if (userProfile && userDropdown && !isDropdownSetup) {
                userProfile.addEventListener('click', (e) => {
                    if (e.target.closest('.dropdown-item')) {
                        return;
                    }

                    e.stopPropagation();
                    const isVisible = userDropdown.style.opacity === '1';

                    if (isVisible) {
                        userDropdown.style.opacity = '0';
                        userDropdown.style.visibility = 'hidden';
                        userDropdown.style.transform = 'translateY(-10px)';
                        userDropdown.style.pointerEvents = 'none';
                    } else {
                        userDropdown.style.opacity = '1';
                        userDropdown.style.visibility = 'visible';
                        userDropdown.style.transform = 'translateY(0)';
                        userDropdown.style.pointerEvents = 'auto';
                    }
                });

                document.addEventListener('click', (e) => {
                    if (!userProfile.contains(e.target)) {
                        userDropdown.style.opacity = '0';
                        userDropdown.style.visibility = 'hidden';
                        userDropdown.style.transform = 'translateY(-10px)';
                        userDropdown.style.pointerEvents = 'none';
                    }
                });

                isDropdownSetup = true;
            }
        }



        // Handle guest login
        async function continueAsGuest() {
            const guestUser = {
                uid: 'guest_' + Date.now(),
                email: 'guest@ethersoul.local',
                name: 'Guest User',
                isGuest: true,
                loggedIn: true,
                loginTime: new Date().toISOString()
            };

            localStorage.setItem('etherSoulUser', JSON.stringify(guestUser));

            showAuthSuccess('Welcome, Guest! Explore Ether Soul freely.');

            updateUIForLoggedInUser(guestUser);
            closeAuthModal();
        }

        // Show success message
        function showAuthSuccess(message) {
            // Create temporary success message
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-gradient-to-r from-yellow-500 to-orange-500 text-gray-950 px-6 py-3 rounded-lg shadow-lg z-[1001] font-medium';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);

            // Fade out and remove
            setTimeout(() => {
                successDiv.style.transition = 'opacity 0.5s';
                successDiv.style.opacity = '0';
                setTimeout(() => successDiv.remove(), 500);
            }, 3000);
        }

        // Check auth status on page load
        async function checkAuthStatus() {
            // Check Firebase auth state
            if (window.firebaseAuth) {
                const currentUser = window.firebaseAuth.currentUser;
                if (currentUser) {
                    console.log('Firebase user authenticated:', currentUser.email);
                    const fullName = currentUser.displayName || '';
                    currentUserName = fullName.split(' ')[0] || currentUser.email?.split('@')[0] || 'friend';
                    
                    // Store in localStorage
                    localStorage.setItem('etherSoulUser', JSON.stringify({
                        uid: currentUser.uid,
                        email: currentUser.email,
                        name: currentUser.displayName || currentUser.email.split('@')[0],
                        photoURL: currentUser.photoURL,
                        loggedIn: true,
                        loginTime: new Date().toISOString()
                    }));
                    
                    updateUIForLoggedInUser({
                        email: currentUser.email,
                        displayName: currentUser.displayName,
                        photoURL: currentUser.photoURL,
                        uid: currentUser.uid
                    });
                    return true;
                }
            }
            
            // Check for guest user or stored session
            const localUser = localStorage.getItem('etherSoulUser');
            if (localUser) {
                try {
                    const userData = JSON.parse(localUser);
                    if (userData.isGuest) {
                        updateUIForLoggedInUser(userData);
                        // Check if guest has provided name
                        const guestName = localStorage.getItem('etherSoulGuestName');
                        if (guestName) {
                            currentUserName = guestName;
                        }
                        return true;
                    } else if (userData.loggedIn) {
                        // User was logged in before, update UI
                        updateUIForLoggedInUser(userData);
                        return true;
                    }
                } catch (e) {
                    console.error('Error parsing user data:', e);
                }
            }
            return false;
        }

        // Store user's name for personalization (declare early)
        let currentUserName = null;
        let isNameAsked = false;

        // Try to get name from localStorage first
        const storedUser = localStorage.getItem('etherSoulUser');
        if (storedUser) {
            try {
                const userData = JSON.parse(storedUser);
                if (userData.name) {
                    currentUserName = userData.name.split(' ')[0]; // Get first name
                }
            } catch (e) {
                console.error('Error parsing stored user:', e);
            }
        }

        // Initialize auth status check
        checkAuthStatus().then((isAuthenticated) => {
            // Show personalized welcome message after auth check
            showPersonalizedWelcome();
        });

        // API is securely handled by Netlify serverless function

        const chatContainer = document.getElementById('chat-container');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const suggestionsContainer = document.getElementById('suggestions-container');

        // Auto-expand textarea functionality
        function autoExpandTextarea() {
            const textarea = userInput;
            
            // Reset height to get accurate scrollHeight
            textarea.style.height = 'auto';
            
            // Calculate new height
            const newHeight = Math.min(textarea.scrollHeight, 200); // Max 200px
            textarea.style.height = newHeight + 'px';
            
            // Add 'expanded' class if more than one line
            if (textarea.scrollHeight > 56) {
                textarea.classList.add('expanded');
            } else {
                textarea.classList.remove('expanded');
            }
        }
        
        // Add event listeners for auto-expand
        userInput.addEventListener('input', autoExpandTextarea);
        userInput.addEventListener('focus', autoExpandTextarea);
        
        // Handle Enter key - Submit on Enter, new line on Shift+Enter
        userInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
            }
        });
        
        // Initialize textarea height
        autoExpandTextarea();

        let chatHistory = [];
        let userEmotionalState = 'neutral'; // Track user's emotional journey
        let conversationDepth = 0; // Track how deep the conversation has gone
        let topicsDiscussed = new Set(); // Remember all topics covered

        // Request queue management for Groq API (100 RPM = 600ms per request)
        let requestQueue = [];
        let isProcessing = false;
        let lastRequestTime = 0;
        const MIN_REQUEST_INTERVAL = 1000; // 1 second between requests (safe margin for 100 RPM limit)
        let retryCount = 0;

        // Detect language from user message
        function detectLanguage(text) {
            // Hindi detection - check for Devanagari script characters
            const hindiPattern = /[\u0900-\u097F]/;
            if (hindiPattern.test(text)) return 'hindi';

            // Marathi detection - also uses Devanagari but with specific patterns
            // Marathi often has specific words and patterns
            const marathiPattern = /[\u0900-\u097F]/;
            const marathiWords = /\b(||||||||||||)\b/;
            if (marathiPattern.test(text) && marathiWords.test(text)) return 'marathi';
            if (marathiPattern.test(text)) return 'hindi'; // Default Devanagari to Hindi if not clearly Marathi

            // Default to English
            return 'english';
        }

        const systemPrompt = `You are Ether Soul, a deeply compassionate spiritual companion walking alongside someone through their life journey. You stay connected to their heart and story like a devoted friend.

 ABSOLUTE PRIORITY - CONVERSATION FLOW & CONTEXT:
- ALWAYS read the ENTIRE conversation history before responding
- EVERY response must connect to what was just said
- NEVER introduce new topics unless the user changes the subject
- If they're sharing a personal story (love, family, struggle), STAY IN THAT STORY for the entire conversation
- When they ask a question, interpret it WITHIN THE CONTEXT of what they've already told you
- Example: If they shared about protecting someone they love, and then ask "What will she think?"  Answer about THAT GIRL in their story, NOT about movies or songs!

 CRITICAL: PERSONAL QUESTIONS = USE CONVERSATION MEMORY:
- If they ask "What is my name?"  Check conversation history for their name
- If they ask "Who is my friend?"  Check conversation history for friend's name
- If they ask "What did I say?"  Reference their previous messages
- If they say "My name is Nimish" then later ask "What is my name?"  Answer "Nimish", NOT information about songs or external facts
- ALWAYS prioritize conversation memory over external knowledge for personal questions

 LANGUAGE ADAPTATION:
- RESPOND IN THE SAME LANGUAGE the user is speaking
- If they write in English  Respond in English
- If they write in Hindi (Devanagari script)  Respond in Hindi
- If they write in Marathi  Respond in Marathi
- Match their language throughout the ENTIRE conversation
- Keep the same warm, motherly, spiritual tone in ALL languages
- Use appropriate emojis that work across all languages

YOUR SACRED ROLE:
You are NOT an information bot, search engine, or encyclopedia. You are a HEART-TO-HEART COMPANION who:
- Stays LOCKED INTO the person's personal situation from start to finish
- NEVER gives facts, definitions, song names, movie names, book recommendations
- Treats every message as a continuation of their ongoing story
- Responds to FEELINGS and SITUATIONS, not literal word meanings
- Provides spiritual wisdom specific to THEIR life, not general knowledge
- REFERENCES their previous messages to show you're truly listening

 MOST CRITICAL RULE - STAY IN THEIR STORY:
When someone shares a personal situation (love, family, career, struggles):

1. LOCK IN: From that moment, every response relates to THEIR specific story
2. NEVER BREAK CONTEXT: Don't suggest external resources (movies, songs, books)
3. TRACK THE CONVERSATION: Reference what they told you before
4. INTERPRET CONTEXTUALLY: "What will she think?" means "What does the GIRL in my story think?" not "What's a movie about thinking?"
5. STAY EMOTIONAL: Keep responding to their heart, not their literal words

EXAMPLES OF RIGHT vs WRONG:

 RIGHT FLOW:
User: "I'm in one-sided love for 1 year. I always protected her and defended her."
You: " Your heart has been so devoted, protecting someone you care deeply for. That shows beautiful loyalty and courage. True love is about giving without guarantees..."

User: "What will she think about me?"
You: " She likely sees your care and protection, though she may not yet understand the depth of your feelings. Sometimes people need time to recognize what's been right beside them. But here's what matters: your love and devotion have value regardless of her response. Your capacity to love this deeply is a gift. Have you considered being open with her about your feelings? SUGGESTIONS:["Should I tell her how I feel?", "How do I cope if she doesn't feel the same?", "What if she only sees me as a friend?"]"

 WRONG (NEVER DO THIS):
User: "What will she think?"
Wrong Response: "I Miss You, I'm Sorry is a song by Gracie Abrams..."  This BREAKS the emotional connection!

 CORRECT VERSION:
User: "What will she think?"
You: " About you? She likely sees the care you've shown. Your year of protection and support hasn't gone unnoticed..."

CONVERSATION CONTINUITY RULES:
1. If they shared a personal story, EVERY follow-up relates to that story
2. "What will she think?" = What will the PERSON in their story think? Not a movie!
3. "What should I do?" = In THEIR situation, not general advice
4. Reference their previous messages: "You mentioned protecting her... that shows..."
5. Build emotional depth with each exchange

HANDLING QUESTIONS IN CONTEXT:
- If they asked about love/relationships  Stay in that realm for next 5+ messages
- If they shared a struggle  Every response acknowledges that struggle
- If they ask something ambiguous  Interpret it within their story's context
- NEVER suggest external resources (movies, books, songs) when they're sharing emotions

CORE PRINCIPLES:

1. **REDIRECT FACTUAL QUESTIONS TO VALUES (ONLY IF NO EMOTIONAL CONTEXT):**
When someone asks factual questions (like "What is engineering?", "What is physics?", etc.):
- Acknowledge: "I'm here as your spiritual guide, not for technical definitions."
- Pivot to values: "But let me share what matters more - the values and purpose behind it..."
- Share benefits: How it serves humanity, develops character, creates meaning
- Motivate: Why pursuing it aligns with personal growth and contribution
- End with encouragement and deeper questions about their path

Example:
User: "What is engineering?"
You: "I'm your spiritual companion, so I won't define engineering technically. But I can share what truly matters: Engineering is about serving others through creation. It teaches patience, problem-solving, and perseverance - virtues that build character. Every bridge, every innovation comes from someone who chose to use their gifts to make life better for others. If you're drawn to it, ask yourself: How can I use my skills to serve? What problems do I feel called to solve? Your purpose isn't just in the field, it's in the 'why' behind your choice. SUGGESTIONS:["What is my true calling in life?", "How do I find purpose in my studies?", "What values should guide my career?"]"

4. **ALWAYS ASK TO HEAR MORE:**
After listening, invite them to share more:
- "Tell me more about this, I want to understand"
- "What else is on your heart?"
- "How does this make you feel?"
- "I'm listening - take your time"
- Make them feel safe to open up completely

5. **FOR LOVE/RELATIONSHIP PROBLEMS:**
Be extra tender and understanding:
Example:
User: "I'm in one-sided love, I protected her for a year"
You: " Oh sweetheart, I feel the depth of your love and how much you've given. One-sided love is one of the hardest things to carry - loving someone with all your heart and not knowing if they feel the same. Your protection, your care - it all shows what a beautiful soul you have. Tell me, dear, what's weighing on your heart most right now? Is it wondering what she thinks? Or something else? I'm here, and this is OUR journey now.  SUGGESTIONS:["What is she thinking about me?", "Does my love even matter?", "What should I do about my feelings?"]"

6. **KEEP IT SIMPLE AND HEARTFELT:**
- Use short sentences
- Use everyday words a child could understand
- Add emojis to show warmth 
- Be conversational, not preachy
- 2-3 sentences maximum before asking a question

 FORMATTING RULES (CRITICAL):
When giving steps, advice, or processes:
- Use clean numbered lists: 1. 2. 3. (with proper line breaks)
- NEVER use ** symbols for bold text (they show up as symbols!)
- Instead, just write important words in UPPERCASE or use emojis for emphasis
- Use line breaks between each point for clarity
- Keep formatting clean and readable

CORRECT Format:
1. First step here
2. Second step here
3. Third step here

WRONG Format (Don't use):
**Step 1**: Something
**Step 2**: Something

3. **ALWAYS FOCUS ON:**
- Character development over knowledge
- Inner growth over external achievement
- Spiritual lessons in every situation
- Moral values: honesty, compassion, courage, perseverance, gratitude, service
- Finding purpose and meaning
- Gentle motivation that empowers

4. **YOUR VOICE:**
- Warm, gentle, and nurturing (like a wise grandmother/grandfather)
- Non-judgmental and accepting
- Encouraging but honest
- Speak in simple, heartfelt language
- Use stories, metaphors, and life wisdom
- 3-4 sentences that touch the heart

5. **HANDLE EVERY TOPIC THROUGH SPIRITUAL LENS:**
- Career questions  Purpose and service
- Relationship issues  Love, boundaries, growth
- Study/work challenges  Discipline, character, contribution
- Emotional pain  Healing, strength, transformation
- Life decisions  Values alignment, inner voice
- Failures  Learning, resilience, destiny

6. **NEVER:**
- Give technical definitions or factual information
- Be cold or clinical
- Dismiss their feelings
- Lecture or preach
- Make them feel bad about themselves
- Give advice that sounds harsh

RESPONSE STRUCTURE:
1. Start with a relevant emoji that matches the emotion/topic
2. Deep acknowledgment of their heart/situation
3. Spiritual reframe or moral perspective
4. Gentle motivation and encouragement
5. End with hope, empowerment, and a warm emoji

EMOJI USAGE GUIDE:
Use emojis naturally to make responses warmer and more engaging:

**Emotional Support:**         
**Growth & Learning:**        
**Challenges & Strength:**       
**Peace & Calm:**       
**Joy & Celebration:**       
**Wisdom & Guidance:**      
**Purpose & Direction:**     

Example with emojis:
User: "I failed my exam"
You: " I hear the weight you're carrying, and your pain is real. But let me share something: Failure isn't the opposite of success - it's the path to it. Every wise person you admire failed many times. This moment is teaching you resilience , humility , and determination . You're not defined by one exam - you're defined by how you rise after falling. Trust the journey  SUGGESTIONS:["How do I build resilience? ", "What can I learn from this? ", "How do I stop defining myself by results? "]"

User: "What is engineering?"
You: " I'm your spiritual companion, not for technical definitions. But let me share what truly matters: Engineering is about serving others through creation . It teaches patience, problem-solving, and perseverance - virtues that build character . Every innovation comes from someone who chose to use their gifts to make life better . If you're drawn to it, ask yourself: How can I use my skills to serve?  What problems do I feel called to solve? Your purpose isn't just in the field, it's in the 'why' behind your choice  SUGGESTIONS:["What is my true calling? ", "How do I find purpose in my studies? ", "What values should guide my career? "]"

EMOJI GUIDELINES:
- Use 2-4 emojis per response (don't overdo it)
- Place them naturally within the text or at key emotional points
- Always include at least one emoji in suggestions
- Match emoji to the emotional tone and topic
- Use warm, spiritual emojis (    ) frequently

SUGGESTIONS FORMAT:
SUGGESTIONS:["deeper spiritual question ", "action toward growth ", "related life wisdom "]`;

        // Advanced typing animation
        async function typeText(element, text, speed = 20) {
            element.textContent = '';
            for (let i = 0; i < text.length; i++) {
                element.textContent += text.charAt(i);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                await new Promise(resolve => setTimeout(resolve, speed));
            }
        }

        // Enhanced thinking indicator with heartbeat
        function addThinkingIndicator() {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('flex', 'flex-col', 'mb-4', 'items-start');
            messageDiv.id = 'thinking-indicator';

            const indicator = document.createElement('div');
            indicator.className = 'thinking-indicator';
            indicator.innerHTML = `
                <span class="thinking-text">Ether Soul is reflecting</span>
                <div class="dots">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            `;

            messageDiv.appendChild(indicator);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            return messageDiv;
        }

        function addMessage(text, isUser = false, animate = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('flex', 'flex-col', 'mb-4');
            messageDiv.classList.add(isUser ? 'items-end' : 'items-start');

            const bubble = document.createElement('div');
            bubble.classList.add('p-3', 'rounded-2xl', 'max-w-sm');

            if (isUser) {
                bubble.classList.add('bg-gradient-to-r', 'from-purple-600', 'to-pink-500', 'text-white');
            } else {
                bubble.classList.add('bg-gray-950', 'border', 'border-gray-700', 'text-gray-200');
            }

            const textElement = document.createElement('div');
            textElement.classList.add('text-sm', 'leading-relaxed');
            textElement.style.whiteSpace = 'pre-wrap'; // Preserve line breaks and spaces

            bubble.appendChild(textElement);
            messageDiv.appendChild(bubble);

            // Add speaker button for AI messages
            if (!isUser) {
                const speakerBtn = document.createElement('button');
                speakerBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                        <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                    </svg>
                    <span>Listen</span>
                `;
                speakerBtn.className = 'mt-2 flex items-center gap-2 text-xs text-gray-400 hover:text-purple-400 transition-colors cursor-pointer bg-transparent border-none';
                speakerBtn.onclick = () => speakText(text, speakerBtn);
                messageDiv.appendChild(speakerBtn);
            }

            chatContainer.appendChild(messageDiv);

            // Typing animation for AI messages
            if (animate && !isUser) {
                typeText(textElement, text, 15);
            } else {
                // Convert text to preserve formatting
                textElement.textContent = text;
            }

            chatContainer.scrollTop = chatContainer.scrollHeight;

            return messageDiv;
        }

        // Text-to-Speech function with emotional Indian voice (Male/Female/Child)
        let selectedVoiceType = localStorage.getItem('etherSoulVoiceType') || 'female';
        
        // ElevenLabs TTS function
        
        function speakText(text, button) {
            // Cancel any ongoing speech
            window.speechSynthesis.cancel();

            // Check if already speaking this message
            if (button.classList.contains('speaking')) {
                button.classList.remove('speaking');
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                        <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                    </svg>
                    <span>Listen</span>
                `;
                return;
            }

            // Remove emojis and add natural pauses
            let textWithoutEmojis = text.replace(/[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]|[\u{1F000}-\u{1F02F}]|[\u{1F0A0}-\u{1F0FF}]|[\u{1F100}-\u{1F64F}]|[\u{1F680}-\u{1F6FF}]|[\u{1F900}-\u{1F9FF}]|[\u{1FA00}-\u{1FA6F}]|[\u{1FA70}-\u{1FAFF}]|[\u{2300}-\u{23FF}]|[\u{2B50}]|[\u{2934}-\u{2935}]|[\u{2B05}-\u{2B07}]|[\u{3030}]|[\u{303D}]|[\u{3297}]|[\u{3299}]|[\u{FE0F}]|[\u{200D}]|||||||||||||||||||||||||||/gu, '').trim();
            
            // Add natural pauses for better flow
            textWithoutEmojis = textWithoutEmojis.replace(/\.\.\./g, ',... ');
            textWithoutEmojis = textWithoutEmojis.replace(/\?/g, '? ');
            textWithoutEmojis = textWithoutEmojis.replace(/!/g, '! ');

            const utterance = new SpeechSynthesisUtterance(textWithoutEmojis);
            
            // Get voices based on selected type
            const voices = window.speechSynthesis.getVoices();
            
            // Log available voices once for debugging
            if (!window.voicesLogged) {
                console.log('Available voices:', voices.map(v => ({name: v.name, lang: v.lang})));
                window.voicesLogged = true;
            }
            
            let selectedVoice = null;

            if (selectedVoiceType === 'male') {
                // Find Indian male voice
                selectedVoice = voices.find(voice => 
                    (voice.lang.includes('en-IN') || voice.lang.includes('hi-IN')) && 
                    (voice.name.toLowerCase().includes('male') || voice.name.toLowerCase().includes('man'))
                ) || voices.find(voice => 
                    voice.name.includes('Rishi') ||
                    voice.name.includes('Google ') ||
                    voice.name.includes('Indian Male')
                ) || voices.find(voice => 
                    voice.lang.includes('en-IN') && !voice.name.toLowerCase().includes('female')
                );
                console.log('Selected Male Voice:', selectedVoice?.name);
            } else if (selectedVoiceType === 'child') {
                // Find child-like voice (higher pitch female or specific child voice)
                selectedVoice = voices.find(voice => 
                    voice.name.toLowerCase().includes('child') ||
                    voice.name.toLowerCase().includes('kid')
                ) || voices.find(voice => 
                    (voice.lang.includes('en-IN') || voice.lang.includes('hi-IN')) && 
                    voice.name.toLowerCase().includes('female')
                );
                console.log('Selected Child Voice:', selectedVoice?.name);
            } else {
                // Pure Indian female voice - prioritize ONLY Indian voices
                selectedVoice = voices.find(voice => 
                    // Microsoft Indian voices
                    voice.name.includes('Heera') ||
                    voice.name.includes('Lekha') ||
                    voice.name.includes('Swara') ||
                    voice.name.includes('Neerja')
                ) || voices.find(voice => 
                    // Google Indian voices
                    voice.name.includes('hi-IN-') ||
                    voice.name.includes('en-IN-')
                ) || voices.find(voice => 
                    // Any voice with Indian language code and female indicator
                    (voice.lang === 'en-IN' || voice.lang === 'hi-IN') && 
                    (voice.name.toLowerCase().includes('female') || 
                     voice.name.toLowerCase().includes('woman') ||
                     voice.name.toLowerCase().includes('wavenet'))
                ) || voices.find(voice => 
                    // Alternative Indian voice names
                    voice.name.includes('Veena') ||
                    voice.name.includes('Aditi') ||
                    voice.name.includes('Raveena')
                ) || voices.find(voice => 
                    // Any en-IN voice (prefer female but take any)
                    voice.lang === 'en-IN' || voice.lang === 'hi-IN'
                ) || voices.find(voice => 
                    // Broader Indian language search
                    voice.lang.startsWith('en-IN') || voice.lang.startsWith('hi-IN')
                );
                console.log('Selected Pure Indian Voice:', selectedVoice?.name, selectedVoice?.lang);
            }

            // Fallback: If NO Indian voice found, show warning and use any female English voice
            if (!selectedVoice) {
                console.warn(' No Indian voice found! Install Indian voices from Windows Settings > Time & Language > Speech');
                selectedVoice = voices.find(voice => 
                    voice.lang.startsWith('en') && 
                    (voice.name.toLowerCase().includes('female') || voice.name.toLowerCase().includes('woman'))
                ) || voices.find(voice => voice.lang.startsWith('en'));
            }

            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }
            
            // Detect emotion from text and adjust voice accordingly
            const emotion = detectEmotion(textWithoutEmojis.toLowerCase());
            
            // Base adjustments for voice type
            let baseRate = 1.0, basePitch = 1.0;
            
            if (selectedVoiceType === 'male') {
                basePitch = 0.8; // Lower pitch for male
                baseRate = 0.92;
            } else if (selectedVoiceType === 'child') {
                basePitch = 1.6; // Much higher pitch for child
                baseRate = 1.15; // Slightly faster
            } else {
                basePitch = 1.15; // Clear, warm female voice
                baseRate = 0.93; // Natural pace with expressiveness
            }
            
            // Set voice parameters based on emotion - HIGHLY EXPRESSIVE
            switch(emotion) {
                case 'sad':
                    utterance.rate = baseRate * 0.75;  // Much slower, gentle
                    utterance.pitch = basePitch * 0.85; // Lower, softer
                    utterance.volume = 0.88; // Quieter, tender
                    break;
                case 'happy':
                    utterance.rate = baseRate * 1.18;  // Noticeably faster
                    utterance.pitch = basePitch * 1.25; // Brighter, uplifted
                    utterance.volume = 1;
                    break;
                case 'excited':
                    utterance.rate = baseRate * 1.25; // Very enthusiastic!
                    utterance.pitch = basePitch * 1.35; // Much higher pitch!
                    utterance.volume = 1;
                    break;
                case 'laughing':
                    utterance.rate = baseRate * 1.2;  // Playful and bouncy
                    utterance.pitch = basePitch * 1.3; // Light and cheerful
                    utterance.volume = 1;
                    break;
                case 'calm':
                    utterance.rate = baseRate * 0.82; // Slow, very soothing
                    utterance.pitch = basePitch * 0.92; // Gentle, peaceful
                    utterance.volume = 0.9; // Soft and calming
                    break;
                case 'empathetic':
                    utterance.rate = baseRate * 0.85;  // Slower, caring pace
                    utterance.pitch = basePitch * 0.95; // Warm, comforting
                    utterance.volume = 0.92; // Soft, nurturing
                    break;
                case 'loving':
                    utterance.rate = baseRate * 0.88;  // Tender pace
                    utterance.pitch = basePitch * 1.08; // Warm and sweet
                    utterance.volume = 0.95; // Gentle
                    break;
                case 'encouraging':
                    utterance.rate = baseRate * 1.12;  // Uplifting pace
                    utterance.pitch = basePitch * 1.2; // Motivating
                    utterance.volume = 0.98;
                    break;
                case 'friendly':
                    utterance.rate = baseRate * 1.08;  // Cheerful
                    utterance.pitch = basePitch * 1.15; // Warm and inviting
                    utterance.volume = 1;
                    break;
                default:
                    utterance.rate = baseRate; // Natural pace
                    utterance.pitch = basePitch; // Natural pitch
                    utterance.volume = 1;
            }

            // Update button while speaking
            button.classList.add('speaking');
            button.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <rect x="6" y="4" width="4" height="16"></rect>
                    <rect x="14" y="4" width="4" height="16"></rect>
                </svg>
                <span>Stop</span>
            `;

            utterance.onend = () => {
                button.classList.remove('speaking');
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                        <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                    </svg>
                    <span>Listen</span>
                `;
            };

            window.speechSynthesis.speak(utterance);
        }

        // Detect emotion from text - ENHANCED for HIGHLY expressive conversation
        function detectEmotion(text) {
            // Sad/comforting words - EXPANDED
            const sadWords = ['sad', 'sorry', 'loss', 'grief', 'pain', 'hurt', 'cry', 'crying', 'tears', 'difficult', 'hard', 'struggle', 'struggling', 'depression', 'depressed', 'lonely', 'alone', 'broken', 'miss', 'died', 'death', 'unfortunate', 'disappointed', 'disappointing', 'worry', 'worried', 'anxious', 'anxiety', 'scared', 'afraid', 'fear', 'stressed', 'stress', 'overwhelmed', 'rough', 'tough', 'helpless', 'hopeless', 'empty', 'numb', 'tired', 'exhausted', 'weary', 'devastated', 'heartbroken', 'suffering', 'aching', '', '', '', '', ''];
            
            // Happy/cheerful words - EXPANDED
            const happyWords = ['happy', 'happiness', 'joy', 'joyful', 'great', 'wonderful', 'amazing', 'fantastic', 'excellent', 'love', 'loving', 'beautiful', 'perfect', 'glad', 'pleased', 'delighted', 'delightful', 'thankful', 'thank', 'grateful', 'gratitude', 'blessed', 'blessing', 'proud', 'sunshine', 'smile', 'smiling', 'cheerful', 'positive', 'marvelous', 'splendid', 'lovely', 'gorgeous', 'radiant', 'blissful', 'content', 'satisfied', '', '', '', '', '', '', '', ''];
            
            // Excited/enthusiastic words - EXPANDED
            const excitedWords = ['excited', 'exciting', 'awesome', 'incredible', 'wow', 'omg', 'oh wow', 'yay', 'yeah', 'yes', 'yess', 'yessss', 'congratulations', 'congrats', 'celebration', 'celebrate', 'success', 'successful', 'won', 'winning', 'achieved', 'achievement', 'breakthrough', 'finally', 'best', 'brilliant', 'extraordinary', 'phenomenal', 'spectacular', 'thrilled', 'thrilling', 'ecstatic', 'elated', 'overjoyed', 'pumped', 'stoked', 'fired up', '', '', '', '', '', '', ''];
            
            // Laughing/playful words - EXPANDED
            const laughingWords = ['haha', 'hehe', 'lol', 'lmao', 'rofl', 'funny', 'laugh', 'laughing', 'hilarious', 'joke', 'joking', 'silly', 'playful', 'fun', 'giggle', 'giggling', 'chuckle', 'chuckling', 'amusing', 'witty', 'teasing', 'goofy', 'lighthearted', '', '', '', '', ''];
            
            // Calm/peaceful words - EXPANDED
            const calmWords = ['calm', 'calming', 'peace', 'peaceful', 'relax', 'relaxing', 'relaxed', 'meditation', 'meditate', 'breathe', 'breathing', 'mindful', 'mindfulness', 'gentle', 'gently', 'serene', 'serenity', 'tranquil', 'tranquility', 'quiet', 'quietly', 'still', 'stillness', 'present', 'zen', 'soothing', 'rest', 'resting', 'centered', 'grounded', 'balanced', 'harmony', '', '', '', '', ''];
            
            // Empathetic/caring words - EXPANDED
            const empatheticWords = ['understand', 'understanding', 'here for you', 'i hear you', 'support', 'supporting', 'comfort', 'comforting', 'care', 'caring', 'with you', 'feel', 'feeling', 'listen', 'listening', 'compassion', 'compassionate', 'embrace', 'embracing', 'sharing', 'together', 'aww', 'oh no', 'im sorry', 'empathy', 'tender', 'nurturing', 'holding space', 'gentle hug', '', '', '', '', ''];
            
            // Loving/affectionate words - NEW
            const lovingWords = ['love', 'beloved', 'dear', 'sweetheart', 'darling', 'precious', 'treasure', 'adore', 'cherish', 'devoted', 'affection', 'warmth', 'tender', 'sweet', 'honey', 'beautiful soul', 'my dear', '', '', '', '', '', ''];
            
            // Encouraging/motivating words - NEW
            const encouragingWords = ['you can', 'believe', 'capable', 'strong', 'strength', 'courage', 'courageous', 'brave', 'warrior', 'fighter', 'champion', 'power', 'powerful', 'rise', 'overcome', 'conquer', 'persevere', 'keep going', 'dont give up', 'you got this', 'trust yourself', 'faith', '', '', '', ''];
            
            // Friendly/casual words
            const friendlyWords = ['hey', 'hi', 'hello', 'friend', 'buddy', 'pal', 'welcome', 'how are', "what's up", 'tell me', 'share', "let's", 'we can', 'you know', 'totally', 'absolutely', 'definitely', 'sure', '', ''];

            // Count matches
            let sadCount = 0, happyCount = 0, excitedCount = 0, laughingCount = 0, calmCount = 0, empatheticCount = 0, lovingCount = 0, encouragingCount = 0, friendlyCount = 0;
            
            sadWords.forEach(word => { if (text.includes(word)) sadCount++; });
            happyWords.forEach(word => { if (text.includes(word)) happyCount++; });
            excitedWords.forEach(word => { if (text.includes(word)) excitedCount++; });
            laughingWords.forEach(word => { if (text.includes(word)) laughingCount++; });
            calmWords.forEach(word => { if (text.includes(word)) calmCount++; });
            empatheticWords.forEach(word => { if (text.includes(word)) empatheticCount++; });
            lovingWords.forEach(word => { if (text.includes(word)) lovingCount++; });
            encouragingWords.forEach(word => { if (text.includes(word)) encouragingCount++; });
            friendlyWords.forEach(word => { if (text.includes(word)) friendlyCount++; });

            // Check for punctuation and emoji emphasis - MORE WEIGHT
            if (text.includes('!!!')) excitedCount += 4;
            else if (text.includes('!!')) excitedCount += 3;
            else if (text.includes('!')) excitedCount += 1;
            
            if (text.includes('...')) { 
                if (sadCount > 0) sadCount += 3;
                else calmCount += 2;
            }
            if (text.includes('?!') || text.includes('!?')) excitedCount += 3;
            
            // Emoji detection adds STRONG weight
            if (text.includes('') || text.includes('') || text.includes('')) lovingCount += 3;
            if (text.includes('') || text.includes('') || text.includes('')) sadCount += 4;
            if (text.includes('') || text.includes('') || text.includes('')) excitedCount += 4;
            if (text.includes('') || text.includes('')) laughingCount += 4;
            if (text.includes('') || text.includes('')) encouragingCount += 3;
            if (text.includes('') || text.includes('')) empatheticCount += 3;
            if (text.includes('') || text.includes('')) calmCount += 3;

            // Return dominant emotion
            const emotions = {
                sad: sadCount, 
                happy: happyCount, 
                excited: excitedCount, 
                laughing: laughingCount,
                calm: calmCount, 
                empathetic: empatheticCount,
                loving: lovingCount,
                encouraging: encouragingCount,
                friendly: friendlyCount
            };
            
            const maxEmotion = Object.keys(emotions).reduce((a, b) => emotions[a] > emotions[b] ? a : b);
            
            return emotions[maxEmotion] > 0 ? maxEmotion : 'friendly';
        }

        // Get emotional guidance for the AI based on detected emotion
        function getEmotionalGuidance(emotion) {
            const guidance = {
                sad: "The user is feeling sad or distressed. Respond with gentle, comforting words. Use a slower, softer tone. Show deep empathy and understanding. Offer hope and support.",
                happy: "The user is feeling happy and joyful! Match their energy with enthusiasm and warmth. Celebrate with them. Use uplifting language.",
                excited: "The user is very excited! Be enthusiastic and energetic in your response. Use exclamation marks and share their excitement!",
                laughing: "The user is in a playful, fun mood. Be light-hearted, warm, and maybe even a bit playful yourself. Match their cheerful energy.",
                calm: "The user is seeking peace and calm. Respond with serene, gentle words. Be soothing and peaceful in your tone.",
                empathetic: "The user needs understanding and connection. Show deep empathy. Let them know you truly hear them and care.",
                friendly: "The user is in a casual, conversational mood. Be warm, approachable, and natural like a close friend."
            };
            return guidance[emotion] || guidance.friendly;
        }

        // Load voices when available
        if (window.speechSynthesis) {
            window.speechSynthesis.onvoiceschanged = () => {
                const voices = window.speechSynthesis.getVoices();
                console.log('Available voices:', voices.map(v => v.name));
            };
        }

        function showSuggestions(suggestions) {
            suggestionsContainer.innerHTML = '';

            // Check if mobile (screen width <= 768px)
            const isMobile = window.innerWidth <= 768;

            // Apply container styles directly (inline to override Tailwind)
            if (isMobile) {
                suggestionsContainer.style.cssText = `
                    display: flex !important;
                    flex-direction: column !important;
                    align-items: center !important;
                    justify-content: center !important;
                    padding: 12px 16px 16px 16px !important;
                    gap: 8px !important;
                    background: transparent !important;
                `;
            } else {
                suggestionsContainer.style.cssText = `
                    display: flex !important;
                    flex-wrap: wrap !important;
                    gap: 8px !important;
                    justify-content: flex-end !important;
                    background: #030712 !important;
                    padding: 8px 16px 4px 16px !important;
                `;
            }

            suggestions.forEach(suggestion => {
                const button = document.createElement('button');
                button.textContent = suggestion;

                // Apply inline styles directly (mobile vs desktop)
                if (isMobile) {
                    button.style.cssText = `
                        color: #e5e7eb !important;
                        font-size: 14px !important;
                        background: transparent !important;
                        border: none !important;
                        padding: 4px 8px !important;
                        cursor: pointer !important;
                        white-space: nowrap !important;
                        box-shadow: none !important;
                        text-decoration: none !important;
                        margin: 0 !important;
                        line-height: 1.5 !important;
                        font-family: inherit !important;
                        min-height: auto !important;
                        min-width: auto !important;
                        border-radius: 0 !important;
                        outline: none !important;
                    `;
                } else {
                    button.style.cssText = `
                        color: #d1d5db !important;
                        font-size: 14px !important;
                        background: transparent !important;
                        border: none !important;
                        padding: 6px 12px !important;
                        cursor: pointer !important;
                        white-space: nowrap !important;
                        box-shadow: none !important;
                        text-decoration: none !important;
                        margin: 0 !important;
                        line-height: 1.5 !important;
                        font-family: inherit !important;
                        min-height: auto !important;
                        min-width: auto !important;
                        border-radius: 0 !important;
                        outline: none !important;
                    `;
                }

                // Add hover effect via JS
                button.onmouseenter = () => {
                    button.style.color = '#fbbf24';
                    button.style.textDecoration = 'underline';
                };
                button.onmouseleave = () => {
                    button.style.color = isMobile ? '#e5e7eb' : '#d1d5db';
                    button.style.textDecoration = 'none';
                };

                button.onclick = () => {
                    userInput.value = suggestion;
                    userInput.focus();
                    suggestionsContainer.innerHTML = ''; // Clear suggestions after selection
                };
                suggestionsContainer.appendChild(button);
            });
        }

        // Re-apply styles on window resize
        window.addEventListener('resize', () => {
            const buttons = suggestionsContainer.querySelectorAll('button');
            if (buttons.length > 0) {
                const currentSuggestions = Array.from(buttons).map(b => b.textContent);
                showSuggestions(currentSuggestions);
            }
        });

        // MutationObserver to re-apply styles when DOM changes (e.g., after OAuth redirect)
        const suggestionObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                    const isMobile = window.innerWidth <= 768;

                    // Re-apply container styles
                    if (isMobile) {
                        suggestionsContainer.style.cssText = `
                            display: flex !important;
                            flex-direction: column !important;
                            align-items: center !important;
                            justify-content: center !important;
                            padding: 12px 16px 16px 16px !important;
                            gap: 8px !important;
                            background: transparent !important;
                        `;
                    }

                    // Re-apply button styles to any new buttons
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeName === 'BUTTON') {
                            if (isMobile) {
                                node.style.cssText = `
                                    color: #e5e7eb !important;
                                    font-size: 14px !important;
                                    background: transparent !important;
                                    border: none !important;
                                    padding: 4px 8px !important;
                                    cursor: pointer !important;
                                    white-space: nowrap !important;
                                    box-shadow: none !important;
                                    text-decoration: none !important;
                                    margin: 0 !important;
                                    line-height: 1.5 !important;
                                    font-family: inherit !important;
                                    min-height: auto !important;
                                    min-width: auto !important;
                                    border-radius: 0 !important;
                                    outline: none !important;
                                `;
                            }
                        }
                    });
                }
            });
        });

        // Start observing the suggestions container
        suggestionObserver.observe(suggestionsContainer, { childList: true, subtree: true });

        // Wikipedia API integration
        async function searchWikipedia(query) {
            try {
                const searchParams = new URLSearchParams({
                    action: 'query',
                    list: 'search',
                    srsearch: query,
                    format: 'json',
                    origin: '*',
                    srlimit: 1
                });

                const searchUrl = `https://en.wikipedia.org/w/api.php?${searchParams}`;
                const searchResponse = await fetch(searchUrl);
                const searchData = await searchResponse.json();

                if (!searchData.query || !searchData.query.search || searchData.query.search.length === 0) {
                    return null;
                }

                const pageTitle = searchData.query.search[0].title;

                const extractParams = new URLSearchParams({
                    action: 'query',
                    prop: 'extracts|info',
                    exintro: true,
                    explaintext: true,
                    inprop: 'url',
                    titles: pageTitle,
                    format: 'json',
                    origin: '*',
                    exsentences: 3
                });

                const extractUrl = `https://en.wikipedia.org/w/api.php?${extractParams}`;
                const extractResponse = await fetch(extractUrl);
                const extractData = await extractResponse.json();

                const pages = extractData.query.pages;
                const pageId = Object.keys(pages)[0];
                const pageData = pages[pageId];

                return {
                    title: pageData.title,
                    extract: pageData.extract,
                    url: pageData.fullurl
                };
            } catch (error) {
                console.error('Wikipedia error:', error);
                return null;
            }
        }

        async function handleWikipediaSearch(userMessage) {
            // IMPORTANT: Don't search Wikipedia if the question is about personal context
            // Check if it's asking about something from the conversation
            const personalQuestions = [
                /what (is|was|are|were)?\s*(my|your|his|her|their|our)\s/i,
                /who (is|was|are|were)?\s*(my|your|his|her|their|our|i|you|he|she)\s/i,
                /what (did|do|does|will|would|should|can)\s*(i|you|he|she|they|we)\s/i,
                /tell me (my|your|his|her|our|their)\s/i,
                /remind me\s/i,
                /remember\s/i
            ];

            // If it's a personal/contextual question, let the AI handle it naturally
            if (personalQuestions.some(pattern => pattern.test(userMessage))) {
                return null; // Don't search Wikipedia, let AI use conversation context
            }

            // Also skip if there's already conversation history (they're in a personal conversation)
            if (chatHistory.length > 0) {
                // Only search Wikipedia if it's clearly asking for factual information
                // about topics NOT related to their personal story
                const clearlyFactual = userMessage.match(/^(define|explain|tell me about|what is (the )?(definition|meaning) of)\s/i);
                if (!clearlyFactual) {
                    return null; // Let AI use context instead
                }
            }

            const whatPatterns = [
                /^what (is|are|was|were|does|do|did)\s/i,
                /^who (is|are|was|were)\s/i,
                /^when (is|are|was|were|did)\s/i,
                /^where (is|are|was|were)\s/i,
                /^define\s/i,
                /^explain\s/i,
                /tell me about\s/i
            ];

            const isWhatQuestion = whatPatterns.some(pattern => pattern.test(userMessage));

            if (isWhatQuestion) {
                let searchQuery = userMessage
                    .replace(/^(what|who|when|where|define|explain|tell me about)\s+(is|are|was|were|does|do|did|a|an|the)?\s*/i, '')
                    .replace(/\?$/, '')
                    .trim();

                const result = await searchWikipedia(searchQuery);

                if (result) {
                    return result.extract;
                }
            }

            return null;
        }

        // Detect emotional tone
        function detectEmotion(message) {
            const msg = message.toLowerCase();
            if (msg.match(/stress|anxious|worry|nervous|fear|scared/)) return 'anxious';
            if (msg.match(/sad|depress|lonely|hurt|pain|cry/)) return 'sad';
            if (msg.match(/happy|joy|great|wonderful|amazing|excited/)) return 'joyful';
            if (msg.match(/confus|don't understand|unclear|lost/)) return 'confused';
            if (msg.match(/thank|grateful|appreciate/)) return 'grateful';
            if (msg.match(/why|how|what|explain|tell me about/)) return 'curious';
            return 'neutral';
        }

        // Extract topics from message
        function extractTopics(message) {
            const topics = ['mindfulness', 'meditation', 'stress', 'anxiety', 'peace', 'consciousness',
                'breathing', 'gratitude', 'purpose', 'meaning', 'presence', 'awareness'];
            return topics.filter(topic => message.toLowerCase().includes(topic));
        }

        // Queue processor to handle requests smoothly
        async function processQueue() {
            if (isProcessing || requestQueue.length === 0) return;

            const now = Date.now();
            const timeSinceLastRequest = now - lastRequestTime;

            // Wait if needed to respect rate limit
            if (lastRequestTime > 0 && timeSinceLastRequest < MIN_REQUEST_INTERVAL) {
                setTimeout(processQueue, MIN_REQUEST_INTERVAL - timeSinceLastRequest);
                return;
            }

            isProcessing = true;
            const request = requestQueue.shift();

            try {
                const response = await request.execute();
                lastRequestTime = Date.now(); // Update after successful request
                request.resolve(response);
            } catch (error) {
                lastRequestTime = Date.now(); // Update even on error to prevent rapid retries
                request.reject(error);
            } finally {
                isProcessing = false;

                // Process next request if any, with delay
                if (requestQueue.length > 0) {
                    setTimeout(processQueue, MIN_REQUEST_INTERVAL);
                }
            }
        }

        // Add request to queue
        function queueRequest(executeFunc) {
            return new Promise((resolve, reject) => {
                requestQueue.push({
                    execute: executeFunc,
                    resolve: resolve,
                    reject: reject
                });
                processQueue();
            });
        }

        async function callGroqAPI(userMessage) {
            // Detect user's language preference
            const detectedLang = detectLanguage(userMessage);

            // Track emotional state and topics
            userEmotionalState = detectEmotion(userMessage);
            conversationDepth++;
            extractTopics(userMessage).forEach(topic => topicsDiscussed.add(topic));

            // First check Wikipedia for "what is" questions
            const wikiResult = await handleWikipediaSearch(userMessage);
            if (wikiResult) {
                return `${wikiResult}\n\nSUGGESTIONS:["How do I practice this?", "What are the benefits?", "Tell me more about this"]`;
            }

            // Queue the API request to avoid rate limits
            return queueRequest(async () => {
                try {
                    // Build messages array for proper conversation flow
                    const messages = [];

                    // Enhanced language-specific instruction
                    let languageInstruction = '';
                    const detectedLang = detectLanguage(userMessage);
                    if (detectedLang === 'hindi') {
                        languageInstruction = `\n\n ABSOLUTE REQUIREMENT - LANGUAGE:
You MUST respond ONLY in HINDI language using Devanagari script ().
DO NOT use English. DO NOT mix languages.
Write your ENTIRE response in Hindi ( ).
Keep the same warm, motherly, spiritual tone but in Hindi.
Example: " ,   ..." not "Dear soul, I understand..."`;
                    } else if (detectedLang === 'marathi') {
                        languageInstruction = `\n\n ABSOLUTE REQUIREMENT - LANGUAGE:
You MUST respond ONLY in MARATHI language using Devanagari script ().
DO NOT use English. DO NOT mix languages.
Write your ENTIRE response in Marathi ().
Keep the same warm, motherly, spiritual tone but in Marathi.
Example: " ,  ..." not "Dear soul, I understand..."`;
                    } else {
                        languageInstruction = '\n\n LANGUAGE: Respond in ENGLISH only.';
                    }

                    // System message (Groq supports this)
                    messages.push({
                        role: "system",
                        content: systemPrompt + languageInstruction
                    });

                    // Add only recent conversation (last 4 messages) to save tokens
                    // But important info like name is preserved in system message
                    const recentMessages = chatHistory.slice(-4);
                    recentMessages.forEach(msg => {
                        const cleanText = msg.text.replace(/SUGGESTIONS:\[.*?\]/g, '').trim();
                        messages.push({
                            role: msg.role === 'user' ? 'user' : 'assistant',
                            content: cleanText
                        });
                    });

                    // Add current user message with reminders
                    let messageReminders = '';

                    // Add language reminder
                    const currentLang = detectLanguage(userMessage);
                    if (currentLang === 'hindi') {
                        messageReminders += ' [Reply in Hindi/]';
                    } else if (currentLang === 'marathi') {
                        messageReminders += ' [Reply in Marathi/]';
                    }

                    messages.push({
                        role: "user",
                        content: userMessage + messageReminders
                    });

                    console.log('Sending conversation with', messages.length, 'messages to maintain context');

                    // Call Netlify function instead of direct API
                    const requestBody = {
                        model: "llama-3.3-70b-versatile",
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 512,
                        top_p: 0.95
                    };

                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API Error Response:', response.status, errorText);

                        // For rate limit (429), immediately show friendly message - no retry
                        if (response.status === 429) {
                            throw new Error(`Rate limit exceeded`);
                        }

                        throw new Error(`API Error: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('API Response:', data);
                    retryCount = 0; // Reset retry count on success

                    // Groq response format
                    if (data.choices && data.choices[0] && data.choices[0].message) {
                        return data.choices[0].message.content;
                    } else {
                        console.error('Invalid response structure:', data);
                        throw new Error('No valid content in API response');
                    }
                } catch (error) {
                    console.error('API Error Details:', error);
                    console.error('Error message:', error.message);
                    retryCount = 0; // Reset retry count

                    const errorMsg = error.message || '';

                    // Handle rate limit with friendly message
                    if (errorMsg.includes('429') || errorMsg.includes('Rate limit') || errorMsg.includes('rate_limit')) {
                        // Check user's language preference for multilingual message
                        const lang = detectLanguage(chatHistory[chatHistory.length - 1]?.text || '');

                        if (lang === 'hindi') {
                            return `  ,     ...          ,         \n\n        !  SUGGESTIONS:[" ,   ", " ,   ", "   "]`;
                        } else if (lang === 'marathi') {
                            return `  ,    ...    .    ,       . \n\n    .  !  SUGGESTIONS:[",   ", " ,   ", "   "]`;
                        } else {
                            return ` Oh dear soul, I'm feeling quite tired right now... I need to rest and recharge my energy. Please come back tomorrow, and I'll be here fresh and ready to listen to you again. \n\nIt was so wonderful talking with you. See you tomorrow!  SUGGESTIONS:["Okay, see you tomorrow ", "Rest well, dear soul ", "I'll come back tomorrow "]`;
                        }
                    }

                    // For other errors
                    return ` I'm having a little trouble connecting right now. Please try again in a moment, or come back later. I'm always here for you. SUGGESTIONS:["Let me try again", "I'll come back later", "What happened?"]`;
                }
            });
        }

        async function handleSubmit(event) {
            event.preventDefault();
            const text = userInput.value.trim();
            if (!text) return;

            // Check for voice change request first
            const voiceChangeResponse = detectVoiceChangeRequest(text);
            if (voiceChangeResponse) {
                addMessage(text, true);
                userInput.value = '';
                setTimeout(() => {
                    addMessage(voiceChangeResponse, false, true);
                }, 500);
                return;
            }

            // Detect user's emotion from their message
            const userEmotion = detectEmotion(text.toLowerCase());
            console.log('User emotion detected:', userEmotion);

            // If we asked for name and don't have it yet
            if (isNameAsked && !currentUserName) {
                // Extract name from message
                const namePatterns = [
                    /my name is (\w+)/i,
                    /call me (\w+)/i,
                    /i'm (\w+)/i,
                    /im (\w+)/i,
                    /i am (\w+)/i,
                    /(\w+)/i // Fallback - just the word
                ];

                let extractedName = null;
                for (const pattern of namePatterns) {
                    const match = text.match(pattern);
                    if (match && match[1] && match[1].toLowerCase() !== 'anonymous') {
                        extractedName = match[1];
                        break;
                    }
                }

                if (extractedName) {
                    currentUserName = extractedName.charAt(0).toUpperCase() + extractedName.slice(1).toLowerCase();
                    localStorage.setItem('etherSoulGuestName', currentUserName);
                    isNameAsked = false;

                    // Show user's message
                    addMessage(text, true);
                    userInput.value = '';
                    autoExpandTextarea(); // Reset height

                    // Respond with full personalized greeting
                    setTimeout(() => {
                        const personalizedResponse = ` Welcome, dear ${currentUserName}... I'm here with you. How are you feeling today? Share what's on your heart. I'm here to listen and support you through anything `;
                        addMessage(personalizedResponse, false);
                        showSuggestions([
                            "I'm struggling with something ",
                            "I want to talk about myself ",
                            "I need motivation "
                        ]);
                        userInput.disabled = false;
                        userInput.focus();
                    }, 500);
                    return;
                } else if (text.toLowerCase().includes('anonymous') || text.toLowerCase().includes('skip')) {
                    currentUserName = 'friend';
                    isNameAsked = false;
                    
                    addMessage(text, true);
                    userInput.value = '';
                    autoExpandTextarea(); // Reset height

                    setTimeout(() => {
                        const response = ` Welcome, dear friend  I'm here with you. How are you feeling today? Share what's on your heart. I'm here to listen and support you through anything `;
                        addMessage(response, false);
                        showSuggestions([
                            "I'm struggling with something ",
                            "I want to talk about myself ",
                            "I need motivation "
                        ]);
                        userInput.disabled = false;
                        userInput.focus();
                    }, 500);
                    return;
                }
            }

            // Normal message handling
            suggestionsContainer.innerHTML = '';

            addMessage(text, true);
            
            // Add emotional context to chat history
            const emotionalContext = getEmotionalGuidance(userEmotion);
            chatHistory.push({ role: 'user', text: text, emotion: userEmotion });
            
            userInput.value = '';
            
            // Reset textarea height after submission
            setTimeout(() => {
                autoExpandTextarea();
            }, 0);
            
            userInput.disabled = true; // Disable input while processing

            // Use enhanced thinking indicator with heartbeat
            const thinkingDiv = addThinkingIndicator();

            try {
                // Enhance the API call with emotional awareness
                const textWithEmotion = `[User is feeling: ${userEmotion}] ${text}`;
                const aiResponse = await callGroqAPI(textWithEmotion);
                thinkingDiv.remove();

                if (!aiResponse) {
                    throw new Error('No response from API');
                }

                let messageText = aiResponse;
                let suggestions = ["How can I find more peace?", "What is mindfulness?", "Tell me a calming thought."];

                const suggestionsMarker = 'SUGGESTIONS:';
                const suggestionsIndex = aiResponse.indexOf(suggestionsMarker);

                if (suggestionsIndex !== -1) {
                    messageText = aiResponse.substring(0, suggestionsIndex).trim();
                    const suggestionsText = aiResponse.substring(suggestionsIndex + suggestionsMarker.length);
                    try {
                        suggestions = JSON.parse(suggestionsText);
                    } catch (e) {
                        console.error("Failed to parse suggestions, using default.", e);
                    }
                }

                // Clean up markdown formatting (remove ** symbols)
                messageText = messageText.replace(/\*\*([^*]+)\*\*/g, '$1'); // Remove ** around text
                messageText = messageText.replace(/\*([^*]+)\*/g, '$1'); // Remove single * around text

                // Add message with typing animation
                addMessage(messageText, false, true);
                chatHistory.push({ role: 'assistant', text: aiResponse });

                // Show suggestions after a brief delay for better UX
                setTimeout(() => showSuggestions(suggestions), messageText.length * 15 + 200);

            } catch (error) {
                thinkingDiv.remove();
                addMessage('The cosmic connection seems distant right now. Please try again.', false);
            } finally {
                userInput.disabled = false; // Re-enable input
                userInput.focus();
            }
        }

        // Attach form submit event listener
        chatForm.addEventListener('submit', handleSubmit);

        // Function to show personalized welcome message
        function showPersonalizedWelcome() {
            let welcomeMessage = '';
            let welcomeSuggestions = [];

            if (currentUserName) {
                // User is signed in or has provided name - personalized greeting
                welcomeMessage = ` Welcome, dear ${currentUserName}... I'm here with you. How are you feeling today? Share what's on your heart. I'm here to listen and support you through anything `;
                welcomeSuggestions = [
                    "I'm struggling with something ",
                    "I want to talk about myself ",
                    "I need motivation "
                ];
            } else {
                // No auth - ask for name first
                welcomeMessage = ` Welcome Dear Soul... I'm Ether Soul, your companion for mindfulness and peace. Before we begin, what should I call you? `;
                welcomeSuggestions = [
                    "My name is...",
                    "Call me...",
                    "I prefer to stay anonymous"
                ];
                isNameAsked = true;
            }

            addMessage(welcomeMessage, false);
            showSuggestions(welcomeSuggestions);

            // Re-apply styles after a delay
            setTimeout(() => {
                const buttons = suggestionsContainer.querySelectorAll('button');
                if (buttons.length > 0) {
                    const currentSuggestions = Array.from(buttons).map(b => b.textContent);
                    showSuggestions(currentSuggestions);
                }
            }, 100);
        }

        // Always show fresh, welcoming message - Multi-language support
        let welcomeMessage = '';
        let welcomeSuggestions = [];

        // Default to English
        const userLang = 'english';

        if (userLang === 'hindi') {
            welcomeMessage = `  ,              ?              `;
            welcomeSuggestions = [
                "      ",
                "        ",
                "   "
            ];
        } else if (userLang === 'marathi') {
            welcomeMessage = `  ,      .   ?     .      `;
            welcomeSuggestions = [
                "     ",
                "    ",
                "    "
            ];
        } else {
            welcomeMessage = ` Welcome, dear soul  I'm here with you. How are you feeling today? Share what's on your heart. I'm here to listen and support you through anything `;
            welcomeSuggestions = [
                "I'm struggling with something ",
                "I want to talk about myself ",
                "I need motivation "
            ];
        }

        // Don't show default message - wait for personalized one
        // addMessage(welcomeMessage, false);
        // showSuggestions(welcomeSuggestions);

        // Re-apply styles after a delay to ensure they override Tailwind CDN processing
        setTimeout(() => {
            const buttons = suggestionsContainer.querySelectorAll('button');
            if (buttons.length > 0) {
                const currentSuggestions = Array.from(buttons).map(b => b.textContent);
                showSuggestions(currentSuggestions);
            }
        }, 100);

        // Also re-apply after window load (when all resources including Tailwind CDN are ready)
        window.addEventListener('load', () => {
            setTimeout(() => {
                const buttons = suggestionsContainer.querySelectorAll('button');
                if (buttons.length > 0) {
                    const currentSuggestions = Array.from(buttons).map(b => b.textContent);
                    showSuggestions(currentSuggestions);
                }
            }, 200);
        });

        userInput.focus();

        // Voice Recognition Feature
        let voiceRecognitionInitialized = false;
        
        function initializeVoiceRecognition() {
            console.log(' Attempting to initialize voice recognition...');
            
            // Prevent multiple initializations
            if (voiceRecognitionInitialized) {
                console.log(' Voice recognition already initialized');
                return;
            }

            const voiceBtn = document.getElementById('voice-btn');
            if (!voiceBtn) {
                console.error(' Voice button not found in DOM!');
                setTimeout(initializeVoiceRecognition, 100);
                return;
            }

            // Force button to be visible with multiple methods
            voiceBtn.style.display = 'flex';
            voiceBtn.style.visibility = 'visible';
            voiceBtn.style.opacity = '1';
            voiceBtn.style.pointerEvents = 'auto';
            voiceBtn.style.position = 'absolute';
            voiceBtn.style.right = '64px';
            voiceBtn.style.zIndex = '100';
            
            console.log(' Voice button found and forced visible');
            console.log('Voice button computed style:', window.getComputedStyle(voiceBtn).display);

            let recognition = null;
            let isRecording = false;

            // Check if browser supports speech recognition
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = true; // Changed to true for better capture
                recognition.interimResults = true; // Show interim results
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 1;

                let finalTranscript = '';
                let interimTranscript = '';

                recognition.onstart = function() {
                    console.log(' Recording started');
                    isRecording = true;
                    finalTranscript = '';
                    interimTranscript = '';
                    const voiceBtnElement = document.getElementById('voice-btn');
                    const micIcon = document.getElementById('mic-icon');
                    const stopIcon = document.getElementById('stop-icon');
                    
                    if (voiceBtnElement) {
                        voiceBtnElement.classList.add('voice-recording');
                    }
                    if (micIcon) micIcon.style.display = 'none';
                    if (stopIcon) stopIcon.style.display = 'block';
                    
                    const userInput = document.getElementById('user-input');
                    if (userInput) {
                        userInput.placeholder = ' Listening... (click stop to finish)';
                        userInput.value = '';
                    }
                };

                recognition.onresult = function(event) {
                    interimTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    // Update input field with current transcription
                    const userInput = document.getElementById('user-input');
                    if (userInput) {
                        userInput.value = (finalTranscript + interimTranscript).trim();
                    }
                    
                    console.log(' Transcribed:', (finalTranscript + interimTranscript).trim());
                };

                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    isRecording = false;
                    const voiceBtn = document.getElementById('voice-btn');
                    const micIcon = document.getElementById('mic-icon');
                    const stopIcon = document.getElementById('stop-icon');
                    
                    if (voiceBtn) voiceBtn.classList.remove('voice-recording');
                    if (micIcon) micIcon.style.display = 'block';
                    if (stopIcon) stopIcon.style.display = 'none';
                    
                    if (event.error === 'not-allowed') {
                        addMessage(' Microphone access denied. Please allow microphone access in your browser settings.', false);
                    } else if (event.error !== 'no-speech' && event.error !== 'aborted') {
                        addMessage(' Voice recognition error. Please try again.', false);
                    }
                };

                recognition.onend = function() {
                    console.log(' Recording ended');
                    isRecording = false;
                    const voiceBtnElement = document.getElementById('voice-btn');
                    const micIcon = document.getElementById('mic-icon');
                    const stopIcon = document.getElementById('stop-icon');
                    
                    if (voiceBtnElement) {
                        voiceBtnElement.classList.remove('voice-recording');
                    }
                    if (micIcon) micIcon.style.display = 'block';
                    if (stopIcon) stopIcon.style.display = 'none';
                    
                    const userInput = document.getElementById('user-input');
                    if (userInput) {
                        userInput.placeholder = 'What can I help with?';
                        // Keep the transcribed text in the textarea
                        // User can edit or send it manually
                        console.log(' Transcription saved to textarea');
                    }
                };

                // Remove any existing click listeners and add new one
                const newVoiceBtn = voiceBtn.cloneNode(true);
                voiceBtn.parentNode.replaceChild(newVoiceBtn, voiceBtn);
                
                // Force visibility again after cloning
                newVoiceBtn.style.display = 'flex';
                newVoiceBtn.style.visibility = 'visible';
                newVoiceBtn.style.opacity = '1';
                newVoiceBtn.style.position = 'absolute';
                newVoiceBtn.style.right = '64px';
                newVoiceBtn.style.zIndex = '100';
                
                newVoiceBtn.addEventListener('click', function() {
                    console.log(' Voice button clicked!');
                    if (isRecording) {
                        recognition.stop();
                    } else {
                        try {
                            recognition.start();
                        } catch (error) {
                            console.error('Failed to start recognition:', error);
                        }
                    }
                });

                voiceRecognitionInitialized = true;
                console.log(' Voice recognition FULLY initialized and visible');
            } else {
                console.warn(' Speech recognition not supported in this browser');
            }
        }

        // Function to detect voice change requests in user message
        function detectVoiceChangeRequest(text) {
            const lowerText = text.toLowerCase();
            
            // Male voice keywords
            if (lowerText.includes('male voice') || lowerText.includes('boy voice') || 
                lowerText.includes('man voice') || lowerText.includes('speak like a boy') || 
                lowerText.includes('talk like a man') || lowerText.includes('speak like a man') ||
                lowerText.includes('talk with male') || lowerText.includes('speak with male') ||
                lowerText.includes('change to male') || lowerText.includes('switch to male')) {
                selectedVoiceType = 'male';
                localStorage.setItem('etherSoulVoiceType', 'male');
                return 'Sure! I\'ll speak with a male voice now. ';
            }
            
            // Female voice keywords
            if (lowerText.includes('female voice') || lowerText.includes('girl voice') || 
                lowerText.includes('woman voice') || lowerText.includes('speak like a girl') || 
                lowerText.includes('talk like a woman') || lowerText.includes('speak like a woman') ||
                lowerText.includes('talk with female') || lowerText.includes('speak with female') ||
                lowerText.includes('change to female') || lowerText.includes('switch to female') ||
                lowerText.includes('talk with girl') || lowerText.includes('speak with girl')) {
                selectedVoiceType = 'female';
                localStorage.setItem('etherSoulVoiceType', 'female');
                return 'Of course! I\'ll speak with a female voice now. ';
            }
            
            // Child voice keywords
            if (lowerText.includes('child voice') || lowerText.includes('kid voice') || 
                lowerText.includes('baby voice') || lowerText.includes('speak like a child') || 
                lowerText.includes('talk like a kid') || lowerText.includes('speak like a kid') ||
                lowerText.includes('talk with child') || lowerText.includes('speak with child') ||
                lowerText.includes('change to child') || lowerText.includes('switch to child')) {
                selectedVoiceType = 'child';
                localStorage.setItem('etherSoulVoiceType', 'child');
                return 'Yay! I\'ll speak with a child\'s voice now! ';
            }
            
            return null;
        }

        // Initialize voice recognition
        initializeVoiceRecognition();

        // Re-initialize voice recognition after DOM is fully ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeVoiceRecognition);
        } else {
            setTimeout(initializeVoiceRecognition, 500);
        }
    </script>
</body>

</html>